<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê Secure Chat - Works Everywhere</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
        }
        .form-container {
            text-align: center;
            margin-bottom: 30px;
        }
        h1 { color: #333; margin-bottom: 10px; }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        .chat-layout {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .sidebar {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        .chat-area {
            flex: 2;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        #messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .message-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .message-input input {
            flex: 1;
            margin: 0;
        }
        .status {
            color: #666;
            font-size: 14px;
            margin: 10px 0;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="loginForm" class="form-container">
            <h1>üîê Secure Chat</h1>
            <p>Simple P2P encrypted chat - Works on any hosting!</p>
            <input type="email" id="email" placeholder="Your Email" required>
            <input type="password" id="password" placeholder="Password (min 6 chars)" required minlength="6">
            <button onclick="login()">Login / Register</button>
            <div id="loginStatus" class="status"></div>
        </div>

        <!-- Chat Interface -->
        <div id="chatInterface" style="display: none;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>Welcome, <span id="userCodeDisplay"></span>! üéâ</h2>
                <button onclick="logout()">Logout</button>
            </div>

            <div class="chat-layout">
                <!-- Online Users -->
                <div class="sidebar">
                    <h3>üü¢ Online Users</h3>
                    <div id="onlineUsers">
                        <p class="status">Click "Refresh" to see online users</p>
                    </div>
                    <button onclick="refreshUsers()">üîÑ Refresh Users</button>
                </div>

                <!-- Chat Area -->
                <div class="chat-area">
                    <div id="chatHeader" style="display: none; text-align: center; margin-bottom: 15px;">
                        <h3>üí¨ Chat with <span id="currentTarget"></span></h3>
                        <div>üîê End-to-end encrypted</div>
                    </div>
                    
                    <div id="messages">
                        <p style="text-align: center; color: #666;">Select a user to start chatting üí¨</p>
                    </div>
                    
                    <div id="messageInput" class="message-input" style="display: none;">
                        <input type="text" id="messageText" placeholder="Type your message..." maxlength="500">
                        <button onclick="sendMessage()">üì§ Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple in-memory storage simulation
        let users = new Map();
        let messages = new Map();
        let currentUser = null;
        let currentTarget = null;

        // Simple encryption simulation (for demo - in real app use proper crypto)
        function simpleEncrypt(text) {
            return btoa(text); // Base64 encoding for demo
        }

        function simpleDecrypt(encoded) {
            try {
                return atob(encoded);
            } catch {
                return '[Cannot decrypt]';
            }
        }

        function generateUserCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const status = document.getElementById('loginStatus');

            if (!email || !password || password.length < 6) {
                status.innerHTML = '<span class="error">Please enter valid email and password (6+ chars)</span>';
                return;
            }

            // Simple user creation/login
            let user = users.get(email);
            if (!user) {
                user = {
                    email,
                    password,
                    userCode: generateUserCode(),
                    isOnline: true
                };
                users.set(email, user);
                status.innerHTML = '<span class="success">Account created! Logging in...</span>';
            } else if (user.password !== password) {
                status.innerHTML = '<span class="error">Invalid password!</span>';
                return;
            } else {
                user.isOnline = true;
                status.innerHTML = '<span class="success">Login successful!</span>';
            }

            currentUser = user;
            document.getElementById('userCodeDisplay').textContent = user.userCode;
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('chatInterface').style.display = 'block';
            
            // Auto-refresh users
            refreshUsers();
            setInterval(refreshUsers, 5000); // Refresh every 5 seconds
        }

        function refreshUsers() {
            if (!currentUser) return;

            const onlineUsersDiv = document.getElementById('onlineUsers');
            onlineUsersDiv.innerHTML = '';

            let hasOtherUsers = false;
            users.forEach((user, email) => {
                if (user.isOnline && user.userCode !== currentUser.userCode) {
                    hasOtherUsers = true;
                    const userDiv = document.createElement('div');
                    userDiv.className = 'user-item';
                    userDiv.innerHTML = `
                        <div>
                            <strong>${user.userCode}</strong><br>
                            <small>${email.split('@')[0]}</small>
                        </div>
                        <button onclick="startChat('${user.userCode}', '${email}')">üí¨ Chat</button>
                    `;
                    onlineUsersDiv.appendChild(userDiv);
                }
            });

            if (!hasOtherUsers) {
                onlineUsersDiv.innerHTML = '<p class="status">No other users online. Share this link with friends!</p>';
            }
        }

        function startChat(userCode, email) {
            currentTarget = userCode;
            document.getElementById('currentTarget').textContent = userCode;
            document.getElementById('chatHeader').style.display = 'block';
            document.getElementById('messageInput').style.display = 'flex';
            
            const roomId = [currentUser.userCode, userCode].sort().join('-');
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '<p style="text-align: center; color: green;">üîê Secure chat started!</p>';
            
            loadMessages(roomId);
        }

        function loadMessages(roomId) {
            const roomMessages = messages.get(roomId) || [];
            const messagesDiv = document.getElementById('messages');
            
            roomMessages.forEach(msg => {
                const isOwn = msg.sender === currentUser.userCode;
                const time = new Date(msg.timestamp).toLocaleTimeString();
                const decrypted = simpleDecrypt(msg.message);
                
                const messageHTML = `
                    <div style="margin: 10px 0; padding: 10px; border-radius: 10px; max-width: 70%; ${isOwn ? 'background: #007bff; color: white; margin-left: auto; text-align: right;' : 'background: #f1f1f1; color: black;'}">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                            ${isOwn ? 'You' : msg.sender} ‚Ä¢ ${time}
                        </div>
                        <div>üîí ${decrypted}</div>
                    </div>
                `;
                messagesDiv.insertAdjacentHTML('beforeend', messageHTML);
            });
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            if (!currentUser || !currentTarget) return;

            const messageText = document.getElementById('messageText').value.trim();
            if (!messageText) return;

            const roomId = [currentUser.userCode, currentTarget].sort().join('-');
            const encrypted = simpleEncrypt(messageText);
            
            const messageObj = {
                id: Date.now().toString(),
                sender: currentUser.userCode,
                message: encrypted,
                timestamp: new Date().toISOString()
            };

            if (!messages.has(roomId)) {
                messages.set(roomId, []);
            }
            messages.get(roomId).push(messageObj);

            document.getElementById('messageText').value = '';
            loadMessages(roomId);
        }

        function logout() {
            if (currentUser) {
                currentUser.isOnline = false;
            }
            currentUser = null;
            currentTarget = null;
            
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('chatInterface').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginStatus').textContent = '';
        }

        // Enter key support
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('loginForm').style.display !== 'none') {
                    login();
                } else if (document.getElementById('messageText') === document.activeElement) {
                    sendMessage();
                }
            }
        });

        console.log('üîê Simple Secure Chat loaded - Works on any hosting!');
    </script>
</body>
</html>